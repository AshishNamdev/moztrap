{% load execution urls %}

{% with runcaseversion.caseversion as caseversion %}
{% summary_result_for runcaseversion user environment as result and summary_result%}
{# If the summary_result.tester != user, then this result is from another user, so we use a different css class in some places. #}
{% result_title summary_result user as result_title %}

<article id="test-id-{{ runcaseversion.id }}" class="listitem {{ summary_result.status }}" data-title="{{ caseversion.name }}">

  <div class="itemhead">
    <div class="results">
      <span class="result {% if summary_result.tester != user%}already-{% endif %}{{ summary_result.status }}" title="{{ result_title }}">
        {% if summary_result.status == summary_result.STATUS.assigned or summary_result.status == summary_result.STATUS.started %}
          pending
        {% else %}
          {% if summary_result.tester == user %}
            {{ summary_result.status }}
          {% else %}
            already tested
          {% endif %}
        {% endif %}
      </span>
    </div>

    {% if summary_result.tester == user %}
      {% if summary_result.status == summary_result.STATUS.passed or summary_result.status == summary_result.STATUS.invalidated or summary_result.status == summary_result.STATUS.failed %}
        <form method="post" id="restart-form-{{ runcaseversion.id }}" class="restart">
          {% csrf_token %}
          <button class="action-restart" value="{{ runcaseversion.id }}" name="action-start" title="restart '{{ caseversion.name }}'">restart</button>
        </form>
      {% endif %}
    {% endif %}

    <div class="name">
      <h3 class="title" title="{{ caseversion.name }}">{{ caseversion.name }}</h3>

      {% if summary_result.status == summary_result.STATUS.invalidated %}
        <p class="invalid-note">{{ summary_result.comment }}</p>
        {% endif %}
      {% if summary_result.status == summary_result.STATUS.failed %}
        <p class="failed-note">{{ summary_result.comment }}</p>
        {% endif %}

      {% with caseversion.tags.all as tags %}
      {% if tags %}
      <ul class="tags">
        {% for tag in tags %}
        <li><a href="#{{ tag|slugify }}" title="filter by {{ tag }}" class="filter-link tag" data-type="tag">{{ tag }}</a></li>
        {% endfor %}
      </ul>
      {% endif %}
      {% endwith %}

      {% if summary_result.status == summary_result.STATUS.failed %}
        {% if summary_result.bug_urls %}
          <ul class="buglist">
            {% for bug in summary_result.bug_urls %}
              <li class="bugurl">
                {% include "bugs/bug.html" %}
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endif %}

    </div>

    <div class="suites">
      {% with runcaseversion.suites.all as suites %}
      {% if suites %}
      <ul>
        {% for suite in suites %}
        <li><a href="" title="filter by {{ suite }}" class="filter-link suite" data-type="suite">{{ suite }}</a></li>
        {% endfor %}
      </ul>
      {% endif %}
      {% endwith %}
    </div>

    <div class="order">
        <span> {{ runcaseversion.order }}</span>
    </div>
  </div>

  {% include "runtests/list/_runtest_details.html" %}

</article>

{% endwith %}
